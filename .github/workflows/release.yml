name: Release

on:
  push:
    branches: main

jobs:
  license:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: License validator
        uses: './.github/actions/license'

  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: ESLint
        uses: './.github/actions/eslint'

  typescript:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: TypeScript
        uses: './.github/actions/typescript'

  build:
    needs: [license, lint, typescript]
    permissions:
      contents: write
      pull-requests: write
      statuses: write
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      # - name: Bumping version
      #   uses: jpb06/bump-package@latest
      #   with:
      #     major-keywords: major,BREAKING CHANGE
      #     minor-keywords: feat,minor
      #     patch-keywords: fix,chore

      - name: Install dependencies
        run: npm ci
        shell: bash

      - name: Build React app
        run: npm run build

      - name: Pack build-folder to ZIP-file
        run: |
          cd build
          zip -r ../cloudhood.zip .

      # - name: Get latest tag and set it to ENV
      #   run: |
      #     git fetch --tags
      #     echo "LATEST_TAG=$(git tag -l --sort=-creatordate | head -n 1)" >> $GITHUB_ENV

      - name: Publish
        uses: 'marvinpinto/action-automatic-releases@latest'
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          prerelease: true
          title: Latest build
          automatic_release_tag: 'latest'
          # automatic_release_tag: ${{ env.LATEST_TAG }}
          files: |
            cloudhood.zip
